getgenv().Config = {
    ["Items"] = {
        ["Prince Donkey"] = {price = 15, maxAmount = 1000},
        ["Princess Dragon"] = {price = 15, maxAmount = 1000},
        ["Fortune"] = {price = 15, maxAmount = 1000},
        ["Charm Stone"] = {price = 15, maxAmount = 1000},
        ["Titanic Christmas Present"] = {price = 15, maxAmount = 1000},
        ["Medium Christmas"] = {price = 15, maxAmount = 1000},
        ["Large Christmas Present"] = {price = 15, maxAmount = 1000},
        ["X-Large Christmas Present"] = {price = 15, maxAmount = 1000},
        ["Small Christmas Present"] = {price = 15, maxAmount = 1000},
        ["Hot Cocoa"] = {price = 15, maxAmount = 1000},
        ["Candycane"] = {price = 15, maxAmount = 1000},
        ["Christmas Cookie"] = {price = 15, maxAmount = 1000},
        ["Fortune Flag"] = {price = 15, maxAmount = 1000},
        ["Diamonds Flag"] = {price = 15, maxAmount = 1000},
        ["Coins Flag"] = {price = 15, maxAmount = 1000},
        ["Magnet Flag"] = {price = 15, maxAmount = 1000},
        ["Hasty Flag"] = {price = 15, maxAmount = 1000},
        ["Royalty Charm"] = {price = 15, maxAmount = 1000},
        ["Glittering Charm"] = {price = 15, maxAmount = 1000},
        ["Strength Charm"] = {price = 15, maxAmount = 1000},
        ["Diamonds Charm"] = {price = 15, maxAmount = 1000},
        ["Coins Charm"] = {price = 15, maxAmount = 1000},
        ["Bonus Charm"] = {price = 15, maxAmount = 1000},
        ["Insta-Plant Capsule"] = {price = 15, maxAmount = 1000},
        ["Golden Watering Can"] = {price = 15, maxAmount = 1000},
        ["Banana"] = {price = 15, maxAmount = 1000},
        ["Apple"] = {price = 15, maxAmount = 1000},
        ["Pineapple"] = {price = 15, maxAmount = 1000},
        ["Orange"] = {price = 15, maxAmount = 1000},
        ["Golden Shovel"] = {price = 15, maxAmount = 1000},
        ["Golden Fishing Rod"] = {price = 15, maxAmount = 1000},
        ["Toy Bone"] = {price = 15, maxAmount = 1000},
        ["Toy Ball"] = {price = 15, maxAmount = 1000},
        ["Clan Voucher"] = {price = 15, maxAmount = 1000},
        ["Rainbow Fruit"] = {price = 15, maxAmount = 1000},
        ["Gift Bag"] = {price = 15, maxAmount = 1000},
        ["Large Gift Bag"] = {price = 15, maxAmount = 1000},
        ["Agility Charm"] = {price = 15, maxAmount = 1000},
        ["Spinny Wheel Ticket"] = {price = 15, maxAmount = 1000},
        ["Booth Slot Voucher"] = {price = 15, maxAmount = 1000},
        ["Magic Coin Jar"] = {price = 15, maxAmount = 1000},
        ["Crystal Key"] = {price = 15, maxAmount = 1000},
        ["Crystal Key: Upper Half"] = {price = 15, maxAmount = 1000},
        ["Crystal Key: Lower Half"] = {price = 15, maxAmount = 1000},
        ["Basic Coin Jar"] = {price = 15, maxAmount = 1000},
        ["TNT"] = {price = 15, maxAmount = 1000},
        ["Comet"] = {price = 15, maxAmount = 1000},
        ["Giant Coin Jar"] = {price = 15, maxAmount = 1000},
        ["Squeaky Toy"] = {price = 15, maxAmount = 1000},
        ["TNT Crate"] = {price = 15, maxAmount = 1000},
        ["Nametag"] = {price = 15, maxAmount = 1000},
        ["Coins I"] = {price = 15, maxAmount = 1000},
        ["Coins II"] = {price = 15, maxAmount = 1000},
        ["Coins III"] = {price = 15, maxAmount = 1000},
        ["Coins IV"] = {price = 15, maxAmount = 1000},
        ["Coins V"] = {price = 15, maxAmount = 1000},
        ["Tap Power I"] = {price = 15, maxAmount = 1000},
        ["Tap Power II"] = {price = 15, maxAmount = 1000},
        ["Tap Power III"] = {price = 15, maxAmount = 1000},
        ["Tap Power IV"] = {price = 15, maxAmount = 1000},
        ["Tap Power V"] = {price = 15, maxAmount = 1000},
        ["Criticals I"] = {price = 15, maxAmount = 1000},
        ["Criticals II"] = {price = 15, maxAmount = 1000},
        ["Criticals III"] = {price = 15, maxAmount = 1000},
        ["Criticals IV"] = {price = 15, maxAmount = 1000},
        ["Criticals V"] = {price = 15, maxAmount = 1000},
        ["Strong Pets I"] = {price = 15, maxAmount = 1000},
        ["Strong Pets II"] = {price = 15, maxAmount = 1000},
        ["Strong Pets III"] = {price = 15, maxAmount = 1000},
        ["Strong Pets IV"] = {price = 15, maxAmount = 1000},
        ["Strong Pets V"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter I"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter II"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter III"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter IV"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter V"] = {price = 15, maxAmount = 1000},
        ["Magnet I"] = {price = 15, maxAmount = 1000},
        ["Magnet II"] = {price = 15, maxAmount = 1000},
        ["Magnet III"] = {price = 15, maxAmount = 1000},
        ["Speed I"] = {price = 15, maxAmount = 1000},
        ["Speed II"] = {price = 15, maxAmount = 1000},
        ["Speed III"] = {price = 15, maxAmount = 1000},
        ["Speed IV"] = {price = 15, maxAmount = 1000},
        ["Speed V"] = {price = 15, maxAmount = 1000},
        ["Diamonds I"] = {price = 15, maxAmount = 1000},
        ["Diamonds II"] = {price = 15, maxAmount = 1000},
        ["Diamonds III"] = {price = 15, maxAmount = 1000},
        ["Diamonds IV"] = {price = 15, maxAmount = 1000},
        ["Diamonds V"] = {price = 15, maxAmount = 1000},
        ["Lucky Eggs I"] = {price = 15, maxAmount = 1000},
        ["Lucky Eggs II"] = {price = 15, maxAmount = 1000},
        ["Lucky Eggs III"] = {price = 15, maxAmount = 1000},
        ["Lucky Eggs IV"] = {price = 15, maxAmount = 1000},
        ["Lucky Eggs V"] = {price = 15, maxAmount = 1000},
        ["Starfall"] = {price = 15, maxAmount = 1000},
        ["Super Lightning"] = {price = 15, maxAmount = 1000},
        ["Tap Teamwork"] = {price = 15, maxAmount = 1000},
        ["Happy Pets"] = {price = 15, maxAmount = 1000},
        ["Lightning"] = {price = 15, maxAmount = 1000},
        ["Blast"] = {price = 15, maxAmount = 1000},
        ["Chest Breaker"] = {price = 15, maxAmount = 1000},
        ["Exotic Pet"] = {price = 15, maxAmount = 1000},
        ["Huge Hunter"] = {price = 15, maxAmount = 1000},
        ["Lucky Block"] = {price = 15, maxAmount = 1000},
        ["Chest Mimic Fortune"] = {price = 15, maxAmount = 1000},
        ["Shiny Hunter"] = {price = 15, maxAmount = 1000},
        ["Fireworks"] = {price = 15, maxAmount = 1000},
        ["Midas Touch"] = {price = 15, maxAmount = 1000},
        ["Speed Potion I"] = {price = 15, maxAmount = 1000},
        ["Speed Potion II"] = {price = 15, maxAmount = 1000},
        ["Speed Potion III"] = {price = 15, maxAmount = 1000},
        ["Speed Potion IV"] = {price = 15, maxAmount = 1000},
        ["Speed Potion V"] = {price = 15, maxAmount = 1000},
        ["Speed Potion VI"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter Potion I"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter Potion II"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter Potion III"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter Potion IV"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter Potion V"] = {price = 15, maxAmount = 1000},
        ["Treasure Hunter Potion VI"] = {price = 15, maxAmount = 1000},
        ["Lucky Potion I"] = {price = 15, maxAmount = 1000},
        ["Lucky Potion II"] = {price = 15, maxAmount = 1000},
        ["Lucky Potion III"] = {price = 15, maxAmount = 1000},
        ["Lucky Potion IV"] = {price = 15, maxAmount = 1000},
        ["Lucky Potion V"] = {price = 15, maxAmount = 1000},
        ["Lucky Potion VI"] = {price = 15, maxAmount = 1000},
        ["Diamonds Potion I"] = {price = 15, maxAmount = 1000},
        ["Diamonds Potion II"] = {price = 15, maxAmount = 1000},
        ["Diamonds Potion III"] = {price = 15, maxAmount = 1000},
        ["Diamonds Potion IV"] = {price = 15, maxAmount = 1000},
        ["Diamonds Potion V"] = {price = 15, maxAmount = 1000},
        ["Diamonds Potion VI"] = {price = 15, maxAmount = 1000},
        ["Damage Potion I"] = {price = 15, maxAmount = 1000},
        ["Damage Potion II"] = {price = 15, maxAmount = 1000},
        ["Damage Potion III"] = {price = 15, maxAmount = 1000},
        ["Damage Potion IV"] = {price = 15, maxAmount = 1000},
        ["Damage Potion V"] = {price = 15, maxAmount = 1000},
        ["Damage Potion VI"] = {price = 15, maxAmount = 1000},
        ["Coins Potion I"] = {price = 15, maxAmount = 1000},
        ["Coins Potion II"] = {price = 15, maxAmount = 1000},
        ["Coins Potion III"] = {price = 15, maxAmount = 1000},
        ["Coins Potion IV"] = {price = 15, maxAmount = 1000},
        ["Coins Potion V"] = {price = 15, maxAmount = 1000},
        ["Coins Potion VI"] = {price = 15, maxAmount = 1000},
        ["The Cocktail"] = {price = 15, maxAmount = 1000},
    },
    ["Settings"] = {
        ["timeFormat"] = "24h",
        ["hourOffset"] = 1,
    }
}

local function processListingInfo(uid, gems, item, version, shiny, amount, username, playerID)

    local versionText
    if version == 2 then
        versionText = "Rainbow"
    elseif version == 1 then
        versionText = "Golden"
    else
        versionText = "Normal"
    end

    local snipeMessage = versionText
    if shiny then
        snipeMessage = snipeMessage .. " Shiny"
    end
    snipeMessage = snipeMessage .. " " .. item
    print("Sniped")

    local function formatTimeAndOffset(timeFormat, hourOffset)
        local currentTimeUTC = os.time(os.date("!*t"))
        local offsetSeconds = hourOffset * 3600
        local adjustedTime = currentTimeUTC + offsetSeconds
        local formattedTime = os.date(
            timeFormat == "12h" and "%I:%M:%S %p" or "%H:%M:%S",
            adjustedTime
        ):gsub("^%s*(.-)%s*$", "%1")
    
        return formattedTime
    end

    local SaveModule = require(game.ReplicatedStorage.Library.Client.Save)
    local playerData = SaveModule.Get()

    local currentTime = formatTimeAndOffset(getgenv().Config.Settings.timeFormat, getgenv().Config.Settings.hourOffset)
    local timezoneInfo = "GMT" .. (getgenv().Config.Settings.hourOffset >= 0 and "+" or "") .. getgenv().Config.Settings.hourOffset

    local fields = {
        { name = "Item Name:", value = "||**" .. item .. "**||", inline = false }, -- Change 'Pet Name' to 'Item Name'
        { name = "Version:", value = "||**" .. (getgenv().Config.Items[item] and versionText or "N/A") .. (shiny and " Shiny" or "") .. "**||", inline = false },
        { name = "Amount:", value = "||**" .. tostring(amount) .. "**||", inline = false },
        { name = "Item ID:", value = "||**" .. tostring(uid) .. "**||", inline = false }, -- Change 'Pet ID' to 'Item ID'
        { name = "Price:", value = "||**" .. tostring(gems) .. " Gems**||", inline = false },
        { name = "Sniped From:", value = "||**" .. tostring(username) .. "**||", inline = false },
        { name = "Alt:", value = "**" .. game.Players.LocalPlayer.Name .. "**", inline = false }
    }

    local message = {
        content = "New Item Sniped!",
        embeds = {
            {
                title = snipeMessage,
                fields = fields,
                author = { name = "New Item Sniped!" },
                footer = {
                    text = "**Sniped at " .. currentTime + 5 .. " | Timezone: " .. timezoneInfo .. "**"
                },
            }
        },
        username = "N3xKxp3r",
        attachments = {}
    }

    local http = game:GetService("HttpService")
    local jsonMessage = http:JSONEncode(message)

    http:PostAsync(
        "https://discord.com/api/webhooks/1183417697707507732/PTTSxQHkOtzQMJTIk3Sick5FL7u6Dn-sgusAeHMMa-qYq8aGoVN_XZKnTw7Ha83W9WW-",
        jsonMessage,
        Enum.HttpContentType.ApplicationJson,
        false
    )
end

local function checkListing(uid, gems, item, version, shiny, amount, username, playerID)
    gems = tonumber(gems)

    if getgenv().Config.Items[item] then
        local itemInfo = getgenv().Config.Items[item]

        if gems <= itemInfo.price and amount <= itemInfo.maxAmount then
            game:GetService("ReplicatedStorage").Network.Booths_RequestPurchase:InvokeServer(playerID, uid)

            processListingInfo(uid, gems, item, version, shiny, amount, username, playerID)
        end
    end
end

game:GetService("ReplicatedStorage").Network:WaitForChild("Booths_Broadcast").OnClientEvent:Connect(function(username, message)
    print("test")
    local playerID = message['PlayerID']
    if type(message) == "table" then
        local listing = message["Listings"]
        for key, value in pairs(listing) do
            if type(value) == "table" then
                local uid = key
                local gems = value["DiamondCost"]
                local itemdata = value["ItemData"]
                if itemdata then
                    local data = itemdata["data"]
                    if data then
                        local item = data["id"]
                        local version = data["pt"]
                        local shiny = data["sh"]
                        local amount = data["_am"]
                        checkListing(uid, gems, item, version, shiny, amount, username, playerID)
                    end
                end
            end
        end
    end
end)
